#!/usr/bin/env bash
#SBATCH --job-name BAM_stats
#SBATCH --time 17-12:0:0
#SBATCH --mem 130000
#SBATCH --ntasks 1
#SBATCH --cpus-per-task 13
#SBATCH --output BAM_stats_%j.out
#SBATCH --mail-type FAIL

SEARCH_DIR=$1
BAM_SUFFIX=$2
ID=$3

module load \
  SAMtools

find "${SEARCH_DIR}" -name "*${BAM_SUFFIX}" | while read file; 
do 
	total=$(samtools view "${file}"| cut -f1 | sort -u --parallel ${SLURM_CPUS_PER_TASK} -S9G | wc -l)
	mapped=$(samtools view -F 4 "${file}"| cut -f1 | sort -u  --parallel ${SLURM_CPUS_PER_TASK} -S9G | wc -l)
	unmapped=$(samtools view -c -f 4 "${file}")
	rRNA_nucl=$(samtools view "${file}" chr1H:139089912-139090729 chr1H:139135494-139137698 chr1H:139151036-139151341 chr1H:139151447-139151765 chr1H:139193387-139193485 chr1H:139239600-139239767 chr1H:139270658-139270859 chr1H:139315446-139316527 chr1H:420569993-420574042 chr1H:532955677-532957728 chr1H:543860822-543863405 chr2H:12347034-12353363 chr2H:50162267-50163770 chr2H:62687602-62690444 chr2H:139552739-139557778 chr2H:187506871-187508364 chr2H:187530233-187530495 chr2H:187536858-187538603 chr2H:187540164-187565676 chr2H:187682499-187684241 chr2H:187695824-187697215 chr2H:187795745-187803233 chr2H:235957383-235964125 chr2H:328620694-328622514 chr2H:525339860-525343114 chr2H:525353082-525353628 chr2H:587135034-587136962 chr2H:587301723-587301923 chr2H:756249859-756251040 chr2H:765970376-766051901 chr3H:23999260-24006561 chr3H:41107151-41107456 chr3H:52979651-52984770 chr3H:322365836-322366004 chr3H:420864890-420865195 chr3H:443959820-443959988 chr3H:534061174-534063422 chr3H:562583065-562583686 chr3H:587586387-587587672 chr3H:645253575-645259821 chr3H:666435201-666436731 chr4H:4802433-4805961 chr4H:9758310-9760219 chr4H:99697376-99710127 chr4H:100674549-100675621 chr4H:100801552-100803530 chr4H:148380231-148380980 chr4H:148391243-148392343 chr4H:148436974-148438271 chr4H:148458059-148460186 chr4H:148465194-148465499 chr4H:284133668-284133868 chr4H:608004763-608005739 chr4H:636750299-636750840 chr4H:636816329-636820291 chr4H:636864376-636901966 chr4H:643505736-643506752 chr4H:643514792-643515901 chr4H:643641394-643644339 chr4H:644551948-644565388 chr5H:40632666-40633655 chr5H:59528395-59530037 chr5H:59547311-59570219 chr5H:59559707-59561048 chr5H:59563640-59563813 chr5H:59579177-59579681 chr5H:59594726-59595412 chr5H:59612489-59613557 chr5H:59619810-59620259 chr5H:59647220-59648234 chr5H:59654200-59654615 chr5H:59666631-59666936 chr5H:59681448-59681606 chr5H:59708565-59708735 chr5H:59713638-59750613 chr5H:59721415-59722247 chr5H:59727000-59727189 chr5H:59730174-59730674 chr5H:59736911-59766439 chr5H:59746145-59766091 chr5H:59805684-59806182 chr5H:77004013-77006961 chr5H:137194477-137194834 chr5H:137441520-137441878 chr5H:250280191-250282094 chr5H:290164467-290165657 chr5H:338682752-338683553 chr5H:349935745-349936249 chr5H:457796513-457800039 chr5H:457807510-457809007 chr5H:471969597-471970474 chr5H:538118763-538119131 chr5H:545281729-545284095 chr5H:582637161-582638992 chr5H:623905986-623917335 chr5H:624750275-624751851 chr5H:639807894-639809373 chr5H:639841344-639842539 chr5H:643975529-643977496 chr6H:83568834-83569139 chr6H:83826891-83827196 chr6H:83829888-83830058 chr6H:83830911-83831069 chr6H:83982603-83982958 chr6H:83983356-83983659 chr6H:141738246-141753366 chr6H:279589133-279589438 chr6H:329293536-329294112 chr6H:329296149-329296319 chr6H:355061942-355064521 chr6H:373421634-373424973 chr6H:506374511-506377200 chr6H:525765096-525766145 chr6H:576589497-576592940 chr6H:580104492-580106591 chr7H:40605439-40610797 chr7H:40734383-40737494 chr7H:210019953-210020123 chr7H:210025396-210026626 chr7H:210039286-210040387 chr7H:210055357-210057565 chr7H:210056311-210056531 chr7H:226285016-226286367 chr7H:500367651-500378409 chr7H:557685322-557691841 chr7H:571275289-571276168 chr7H:609245816-609247465 chr7H:609351188-609351877 chr7H:626291774-626294967 chrUn:63300838-63310448 chrUn:63332365-63334719 chrUn:115819186-115819431 chrUn:122000355-122012038 chrUn:122014523-122018316 chrUn:122015289-122015447 chrUn:122043184-122043674 chrUn:122043859-122050134 chrUn:124665018-124686637 chrUn:124699327-124700282 chrUn:124725402-124725560 chrUn:124750176-124750334 chrUn:124750901-124751071 chrUn:124753591-124753896 chrUn:159796497-159797374 chrUn:159802932-159804764 chrUn:159808664-159809473 chrUn:214776304-214778948 chrUn:214835300-214837538 | cut -f1 | sort -u  --parallel ${SLURM_CPUS_PER_TASK} -S9G |wc -l)
	rRNApercentage_nucl=$(bc <<<"scale=2;${rRNA_nucl}*100/${total}")
	total_chloro=$(samtools view "${file}" KT962228.1| cut -f1 | sort -u  --parallel ${SLURM_CPUS_PER_TASK} -S9G |wc -l)
	percentage_totchloro=$(bc <<<"scale=2;${total_chloro}*100/${total}")
	rRNA_chloro=$(samtools view "${file}" KT962228.1:118247-118367 KT962228.1:118595-118689 KT962228.1:118595-118689 KT962228.1:123958-125449 KT962228.1:99767-99887 KT962228.1:99445-99539 KT962228.1:96462-99349 KT962228.1:92685-94176| cut -f1 | sort -u   --parallel ${SLURM_CPUS_PER_TASK} -S9G |wc -l)
    rRNApercentage_chloro=$(bc <<<"scale=2;${rRNA_chloro}*100/${total}")
	total_mc=$(samtools view "${file}" KU865690.1| cut -f1 | sort -u  --parallel ${SLURM_CPUS_PER_TASK} -S9G |wc -l)
	percentage_totmc=$(bc <<<"scale=2;${total_mc}*100/${total}")
	rRNA_mc=$(samtools view "${file}" KU865690.1:49524-49645 KU865690.1:49760-51720 KU865690.1:236788-240254 KU865690.1:236788-240254 KU865690.1:236788-240254 KU865690.1:236788-240254 KU865690.1:337375-340841 KU865690.1:359457-359578 KU865690.1:359693-361653 | cut -f1 | sort -u  --parallel ${SLURM_CPUS_PER_TASK} -S9G | wc -l)
	rRNApercentage_mc=$(bc <<<"scale=2;${rRNA_mc}*100/${total}")
	echo -ne "${file}\t${total}\t${mapped}\t${unmapped}\t${rRNA_nucl}\t${rRNApercentage_nucl}%\t${total_chloro}\t${percentage_totchloro}%\t${rRNA_chloro}\t${rRNApercentage_chloro}%\t${total_mc}\t${percentage_totmc}%\t${rRNA_mc}\t${rRNApercentage_mc}%\n";
done > BAMstats_"${ID}".txt

